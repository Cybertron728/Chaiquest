<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chai Quest: Gujarati Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #0c0a09;
            font-family: 'Plus Jakarta Sans', sans-serif;
            touch-action: none;
        }
        #gameCanvas { display: block; }
        .guj-container {
            background: linear-gradient(145deg, #2d1405 0%, #1a0f05 100%);
            border: 4px solid #5a2e17;
            box-shadow: 0 25px 60px rgba(0,0,0,0.6);
        }
        .btn-guj {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 5px solid rgba(0,0,0,0.4);
        }
        .btn-guj:active { transform: translateY(3px); border-bottom-width: 2px; }
        .pulse-orange { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
    </style>
</head>
<body>

    <!-- UI Overlay -->
    <div id="uiOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="guj-container p-8 md:p-12 rounded-[2.5rem] max-w-md w-full text-white text-center border-t border-white/10">
            <div class="text-6xl mb-4 drop-shadow-lg">â˜•</div>
            <h1 class="text-5xl font-black mb-1 text-orange-400 tracking-tighter uppercase">CHAI QUEST</h1>
            <h2 class="text-xl mb-10 text-yellow-500 font-bold tracking-widest">àª—à«àªœàª°àª¾àª¤à«€ àªàª¡àª¿àª¶àª¨</h2>
            
            <div id="setupForm" class="space-y-6">
                <div class="text-left">
                    <label class="block text-[10px] font-black text-orange-400/60 mb-2 uppercase tracking-[0.2em] ml-1">Commuter Name</label>
                    <input type="text" id="playerName" placeholder="àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª® àª²àª–à«‹..." 
                        class="w-full bg-black/40 border-2 border-orange-900/40 rounded-2xl px-6 py-4 focus:outline-none focus:border-orange-500 text-white text-lg placeholder:text-orange-900/40 transition-all">
                </div>
                
                <div class="space-y-3">
                    <button id="getLocationBtn" class="btn-guj w-full bg-orange-950/30 hover:bg-orange-950/50 border-2 border-orange-500/20 rounded-2xl py-4 flex flex-col items-center justify-center transition-all group">
                        <div class="flex items-center gap-3">
                            <span id="locIcon" class="text-2xl group-hover:scale-110 transition-transform">ğŸ“</span>
                            <span id="locStatus" class="font-extrabold text-orange-100 tracking-wide uppercase">Find Gam Ni Tapri</span>
                        </div>
                        <span class="text-[10px] opacity-40 font-bold mt-1">àª—àª¾àª®àª¨à«€ àªšàª¾àª¨à«€ àªŸàªªàª°à«€ àª¶à«‹àª§à«‹</span>
                    </button>
                    <p id="locHint" class="text-[10px] text-orange-500/60 font-black uppercase tracking-widest text-center animate-pulse">* Location Required to Start</p>
                </div>

                <button id="startGameBtn" disabled class="btn-guj w-full bg-orange-500 hover:bg-orange-400 disabled:opacity-10 disabled:grayscale rounded-2xl py-5 text-2xl font-black text-white shadow-2xl uppercase tracking-tighter transition-all">
                    Chalo Chai Piva!
                </button>
            </div>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud" class="fixed top-0 left-0 right-0 p-6 flex justify-between items-start pointer-events-none hidden">
        <div class="bg-black/70 backdrop-blur-xl px-6 py-4 rounded-[1.5rem] border border-white/10 text-white shadow-2xl">
            <div class="text-[10px] font-black text-orange-500 uppercase tracking-[0.2em] mb-1">Cutting Chai</div>
            <div class="text-4xl font-black tabular-nums" id="scoreDisplay">0</div>
        </div>
        <div class="bg-black/70 backdrop-blur-xl px-6 py-4 rounded-[1.5rem] border border-white/10 text-right shadow-2xl">
            <div id="displayPlayerName" class="font-black text-white uppercase text-sm tracking-tight mb-1">Traveler</div>
            <div id="displayLocation" class="text-[10px] text-green-400 font-black flex items-center justify-end gap-1.5 uppercase">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> GPS Connected
            </div>
        </div>
    </div>

    <!-- Death Modal -->
    <div id="messageBox" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden bg-black/95 backdrop-blur-md">
        <div class="guj-container p-12 text-white text-center max-w-sm w-full rounded-[3rem]">
            <div class="text-7xl mb-6 scale-110">ğŸ¤•</div>
            <h2 class="text-4xl font-black mb-3 text-red-500 tracking-tighter uppercase">CHA DHOLAI GAI!</h2>
            <p class="text-orange-200/50 mb-10 font-bold leading-relaxed">The Rickshaw driver was in a hurry! You spilled the tea.</p>
            <button onclick="resetGame()" class="btn-guj w-full bg-orange-500 rounded-2xl py-5 font-black uppercase text-xl shadow-2xl transition-transform active:scale-95">
                Try Again
            </button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration integrated from user input
        const firebaseConfig = {
            apiKey: "AIzaSyCo7gV6-uBVsuSBuOO-5PkG1-ZaZv5aNOg",
            authDomain: "chaiquest-1ad38.firebaseapp.com",
            projectId: "chaiquest-1ad38",
            storageBucket: "chaiquest-1ad38.firebasestorage.app",
            messagingSenderId: "481025504087",
            appId: "1:481025504087:web:dc51574983acafad760412",
            measurementId: "G-31HTKXWB4R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'chai-quest-prod';
        let currentUser = null;

        // Silent Auth
        signInAnonymously(auth).catch(() => console.error("Firebase Auth failed. Check your config."));
        onAuthStateChanged(auth, (user) => { currentUser = user; });

        // --- Game Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiOverlay = document.getElementById('uiOverlay');
        const hud = document.getElementById('hud');
        const messageBox = document.getElementById('messageBox');
        
        let gameState = 'MENU'; 
        let playerInfo = { name: '', location: '', lat: null, lon: null, locationFetched: false };
        let score = 0;
        const GRID_SIZE = 76;
        let columns, rows;

        // Realistic Rounded Front Rickshaw
        const drawRickshaw = (x, y, size, direction) => {
            ctx.save();
            ctx.translate(x, y);
            if (direction === -1) ctx.scale(-1, 1);
            const w = size * 1.1;
            const h = size * 0.75;
            ctx.fillStyle = '#0a0a0a';
            ctx.beginPath();
            ctx.roundRect(-w/2.2, h/4, w/1.1, h/4, 4);
            ctx.fill();
            ctx.fillStyle = '#fbbf24';
            ctx.beginPath();
            ctx.moveTo(-w/2, h/4);
            ctx.lineTo(-w/2, -h/6);
            ctx.bezierCurveTo(-w/2.2, -h/2.2, w/6, -h/2.2, w/4.5, -h/6);
            ctx.bezierCurveTo(w/2.2, -h/10, w/2.1, h/10, w/2, h/4);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#1e1b1e';
            ctx.beginPath();
            ctx.roundRect(-w/4, -h/10, w/3, h/2.8, 6);
            ctx.fill();
            ctx.fillStyle = '#bae6fd';
            ctx.beginPath();
            ctx.moveTo(w/12, -h/6);
            ctx.bezierCurveTo(w/3.5, -h/6, w/2.2, 0, w/2.15, h/5.5);
            ctx.lineTo(w/8, h/5.5);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(w/2.05, h/8, size/18, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-w/3.2, h/1.9, size/9, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(w/3, h/1.9, size/9, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        };

        const drawPlayer = (x, y, size) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = '#be123c';
            ctx.beginPath();
            ctx.roundRect(-size/3, -size/2.2, size/1.5, size/4, [14, 14, 2, 2]);
            ctx.fill();
            ctx.fillStyle = '#fef08a';
            ctx.beginPath();
            ctx.roundRect(-size/4, -size/4, size/2, size/2.2, 8);
            ctx.fill();
            ctx.fillStyle = '#f97316';
            ctx.beginPath();
            ctx.roundRect(-size/3.5, size/8, size/1.75, size/3.5, 6);
            ctx.fill();
            ctx.restore();
        };

        const drawChai = (x, y, size) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.moveTo(-size/4, -size/3);
            ctx.lineTo(size/4, -size/3);
            ctx.lineTo(size/6, size/3);
            ctx.lineTo(-size/6, size/3);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#78350f';
            ctx.beginPath();
            ctx.moveTo(-size/5, -size/10);
            ctx.lineTo(size/5, -size/10);
            ctx.lineTo(size/8, size/4);
            ctx.lineTo(-size/8, size/4);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        };

        class Commuter {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.floor(columns / 2);
                this.y = rows - 1;
                this.targetX = this.x;
                this.targetY = this.y;
            }
            update() {
                this.x += (this.targetX - this.x) * 0.28;
                this.y += (this.targetY - this.y) * 0.28;
            }
            draw() {
                const px = this.x * GRID_SIZE + GRID_SIZE / 2;
                const py = this.y * GRID_SIZE + GRID_SIZE / 2;
                drawPlayer(px, py, GRID_SIZE * 0.85);
            }
            move(dx, dy) {
                if (gameState !== 'PLAYING') return;
                const nx = this.targetX + dx;
                const ny = this.targetY + dy;
                if (nx >= 0 && nx < columns && ny >= 0 && ny < rows) {
                    this.targetX = nx;
                    this.targetY = ny;
                }
                if (this.targetY === 0) handleWin();
            }
        }

        class AutoRickshaw {
            constructor(row, direction) {
                this.row = row;
                this.direction = direction;
                this.speed = (Math.random() * 0.008 + 0.01) * (1 + score * 0.07);
                this.x = Math.random() * columns;
            }
            update() {
                this.x += this.speed * this.direction;
                if (this.direction === 1 && this.x > columns + 1) this.x = -1;
                if (this.direction === -1 && this.x < -1) this.x = columns + 1;
            }
            draw() {
                const px = this.x * GRID_SIZE + GRID_SIZE / 2;
                const py = this.row * GRID_SIZE + GRID_SIZE / 2;
                drawRickshaw(px, py, GRID_SIZE * 0.95, this.direction);
            }
        }

        let player;
        let autos = [];

        function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            columns = Math.floor(canvas.width / GRID_SIZE);
            rows = Math.floor(canvas.height / GRID_SIZE);
            player = new Commuter();
            generateLevel();
        }

        function generateLevel() {
            autos = [];
            for (let i = 1; i < rows - 1; i++) {
                const direction = Math.random() > 0.5 ? 1 : -1;
                const count = Math.floor(Math.random() * 2) + 1;
                for (let j = 0; j < count; j++) {
                    autos.push(new AutoRickshaw(i, direction));
                }
            }
        }

        function drawBackground() {
            for (let r = 0; r < rows; r++) {
                if (r === 0 || r === rows - 1) {
                    ctx.fillStyle = '#064e3b';
                    ctx.fillRect(0, r * GRID_SIZE, canvas.width, GRID_SIZE);
                    if (r === 0) {
                        const shopX = Math.floor(columns / 2) * GRID_SIZE + GRID_SIZE / 2;
                        drawChai(shopX, GRID_SIZE/2, GRID_SIZE * 0.55);
                    }
                } else {
                    ctx.fillStyle = '#171717';
                    ctx.fillRect(0, r * GRID_SIZE, canvas.width, GRID_SIZE);
                    ctx.strokeStyle = '#262626';
                    ctx.beginPath();
                    ctx.moveTo(0, r * GRID_SIZE);
                    ctx.lineTo(canvas.width, r * GRID_SIZE);
                    ctx.stroke();
                }
            }
        }

        function checkCollisions() {
            for (let auto of autos) {
                const dx = Math.abs(player.x - auto.x);
                if (auto.row === Math.round(player.y) && dx < 0.65) {
                    gameState = 'GAMEOVER';
                    messageBox.classList.remove('hidden');
                }
            }
        }

        function handleWin() {
            score++;
            document.getElementById('scoreDisplay').innerText = score;
            player.reset();
            generateLevel();
        }

        window.resetGame = () => {
            score = 0;
            document.getElementById('scoreDisplay').innerText = score;
            messageBox.classList.add('hidden');
            player.reset();
            generateLevel();
            gameState = 'PLAYING';
        };

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            autos.forEach(auto => { auto.update(); auto.draw(); });
            player.update();
            player.draw();
            if (gameState === 'PLAYING') checkCollisions();
            requestAnimationFrame(gameLoop);
        }

        const getLocationBtn = document.getElementById('getLocationBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const playerNameInput = document.getElementById('playerName');

        getLocationBtn.addEventListener('click', () => {
            const status = document.getElementById('locStatus');
            status.innerText = "GPS SCANNING...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        playerInfo.lat = position.coords.latitude;
                        playerInfo.lon = position.coords.longitude;
                        playerInfo.locationFetched = true;
                        playerInfo.location = `${playerInfo.lat.toFixed(6)}, ${playerInfo.lon.toFixed(6)}`;
                        status.innerText = "TAPRI LOCATED!";
                        document.getElementById('locIcon').innerText = "âœ…";
                        document.getElementById('locHint').style.display = 'none';
                        getLocationBtn.classList.remove('pulse-orange');
                        checkReady();
                    },
                    () => {
                        playerInfo.locationFetched = true;
                        playerInfo.location = "DENIED-BY-USER";
                        status.innerText = "STALL DETECTED";
                        checkReady();
                    },
                    { enableHighAccuracy: true }
                );
            }
        });

        function checkReady() {
            if (playerNameInput.value.trim().length > 1 && playerInfo.locationFetched) {
                startGameBtn.disabled = false;
                startGameBtn.classList.add('pulse-orange');
            }
        }

        playerNameInput.addEventListener('input', checkReady);

        // SILENT LOGGING TO FIRESTORE
        async function silentlyLogPlayer() {
            if (!currentUser) return;
            try {
                // Rule 1: Use specific path structure
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'player_logs'), {
                    name: playerInfo.name,
                    location: playerInfo.location,
                    lat: playerInfo.lat || 0,
                    lon: playerInfo.lon || 0,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });
            } catch (e) { console.error("Logging error", e); }
        }

        startGameBtn.addEventListener('click', () => {
            if (!playerInfo.locationFetched) return;
            playerInfo.name = playerNameInput.value.trim().toUpperCase();
            document.getElementById('displayPlayerName').innerText = playerInfo.name;
            uiOverlay.style.display = 'none';
            hud.classList.remove('hidden');
            gameState = 'PLAYING';
            silentlyLogPlayer();
        });

        // Controls
        window.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'w'].includes(e.key)) player.move(0, -1);
            if (['ArrowDown', 's'].includes(e.key)) player.move(0, 1);
            if (['ArrowLeft', 'a'].includes(e.key)) player.move(-1, 0);
            if (['ArrowRight', 'd'].includes(e.key)) player.move(1, 0);
        });

        let touchStart = null;
        window.addEventListener('touchstart', (e) => { touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY }; }, { passive: false });
        window.addEventListener('touchend', (e) => {
            if (!touchStart) return;
            const dx = e.changedTouches[0].clientX - touchStart.x;
            const dy = e.changedTouches[0].clientY - touchStart.y;
            if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                if (Math.abs(dx) > Math.abs(dy)) player.move(dx > 0 ? 1 : -1, 0);
                else player.move(0, dy > 0 ? 1 : -1);
            }
            touchStart = null;
        });

        window.addEventListener('resize', init);
        init();
        gameLoop();
        getLocationBtn.classList.add('pulse-orange');
    </script>
</body>
</html>

